define(["jquery","client-server","counters","base/view","util/dwh-session","util/helpers","app/channel","apps/catalog","apps/event-countdown","payment/payment-dialog","mimic/mimic","mimic/right-column"],function(a,b,c,d,e,f,g,h,i,j,k,l){"use strict";var m,n={appClick:23242837,appPromoClick:27620347,groupClick:23242897,inviteClick:23242909,likeClick:23242867,openCanvasMenu:18250854,paymentClick:16602271,reviewClick:23242927,settingClick:23242940,showMyNotify:28438951,clickMyNotify:28438979};return m=d.extend({props:{deferred:{banners:"app/banners",preroll:"apps/preroll",modal:"apps/modal"},elements:{advBottom:".app-adv-bottom__wrap",advRight:".app-adv-right",advTop:".app-adv-top__wrap",banner:".app-top-banner",container:".app-frame-container",countdown:".app-event-countdown",eventPopup:".app-event-popup",label:".app-promo__label-inner",leftColumn:".l-app__left",rightColumn:".l-app__right",wrap:".l-app__wrap",myNotificationPopup:".app-my-notification-popup"},events:{"click .app-promo__label":"onAsideLabelClick","click .app-promo__item":"onAppPromoClick","click .b-app-banner-list__target .app-item-pic":"onAppPromoClick","click .apps-list-item__title":"onAppClick","click .apps-game-card__link":"onAppClick","click .app-navigation__button_group":"onGroupClick","click .app-navigation__button_invite":"onInviteClick","click .app-navigation__button_payment":"onPaymentClick","click .app-navigation__button_review":"onReviewClick","click .app-navigation__button_settings":"onSettingsClick","click .app-event-popup__button":"onEventPopupCloseClick","click .app-top-banner__button":"onPaymentClick","click .l-app__canvas":"onOverlayClick","click .l-app__wrap.m-showing-version-3 .l-app__left":"onLeftColumnClick","click .app-my-notification-popup__btn":"onCreateMyAccClick","mouseleave .l-app__wrap .l-app__left":"onLeftColumnMouseleave","mouseover .l-app__wrap.m-showing-version-2 .l-app__left":"onLeftColumnMouseover","mouseover .l-app__wrap.m-show-left-block .l-app__left":"onLeftColumnMouseover"},optionsSelector:".js-app-canvas-data",templates:{"list-item":"app_catalog/tmpl/list-item","create-my-notification":"apps/tmpl/create-my-notification"}},public:{init:function(){return this.isOpened=!1,this.isPaymentOpened=!1,window.top!==window?window.top.location=window.location.href:this.options.needCreateMy&&!this.options.autoCreateMy?this.openModal("create-my-notification",{appNameCutted:this.options.appNameCutted},function(){c.myrb(n.showMyNotify)}):this.initApp(),this},openModal:function(a,b,c){this.require("modal",function(d){b=b||{},this.appsModal?this.templates[a]&&(this.render(a,b,function(a){this.appsModal.open({html:a}),"function"==typeof c&&c()}.bind(this)),this.appsModal.on("close",function(){this.destroyModal()}.bind(this))):(this.appsModal=new d,this.appsModal.ready(function(){this.appsModal.$el.appendTo(this.$el),this.openModal(a,b,c),this.appsModal.getElement().addClass("app-my-notification-popup")}.bind(this)))}.bind(this))},destroyModal:function(){return this.appsModal&&(this.appsModal.$el.remove(),delete this.appsModal),this},closeModal:function(){this.appsModal&&this.appsModal.close()},destroy:function(){return a(document).off(".apps"),this.dwhSession&&(this.dwhSession.destroy(),delete this.dwhSession),this.banner&&(this.banner.destroy(),delete this.banner),this.appsPreroll&&(this.appsPreroll.destroy(),delete this.appsPreroll),this.advRefreshTimer&&(clearTimeout(this.advRefreshTimer),delete this.advRefreshTimer),this.catalog.destroy(),delete this.catalog,this.eventCountdown.destroy(),delete this.eventCountdown,m.__super__.destroy.call(this),this},insertAppFrame:function(){var b=this.options.frame;return b.windowId&&g.setWindowId(b.windowId),window.location.hash&&(b.name="fast_hash="+encodeURIComponent(window.location.hash.replace(/[#\"\']/g,""))+"&"+b.name),b=f.extend({webkitallowfullscreen:"",mozallowfullscreen:"",allowfullscreen:"",frameborder:0,marginheight:0,marginwidth:0,allow:"microphone; camera"},b),this.$frame=a("<iframe>").attr(b).appendTo(this.$container),this},initPreroll:function(){this.require("preroll",function(a){var b={adman:{params:{params:{content_id:this.options.ID}}},locales:this.options.locales};this.options.prerollPreview&&(b.adman.params.params.preview=this.options.prerollPreview),this.appsPreroll=new a(b),this.appsPreroll.on("adman-complete",this.onPrerollClosed.bind(this)),this.appsPreroll.on("adman-start",this.onPrerollStart.bind(this)),this.appsPreroll.render(function(a){this.$preroll=a.appendTo(this.$container),this.appsPreroll.init()}.bind(this))}.bind(this))},initMimic:function(b,c,d){var e="app-right"===b?l:k;e.createRunTime(f.extend(!0,{},f.parseJsonFromSrc(a(".b-mimic-adv-config")),{id:c.id,limit:c.limit,type:c.type,statId:c.statId,parentRestoresCount:1,isAutoRefreshEnable:!0,siteSection:b,rb:{originalSlot:c.rb.originalSlot}}),d)},loadAdvBanners:function(){this.require("banners",function(a){var b=f.extend(!0,[],this.options.banners),c=this.options.mimic;clearTimeout(this.advRefreshTimer),document.hidden&&this.advRefreshTimer||(a.load(b).then(this.onAdvBannersLoaded.bind(this)),c&&c.isEnable&&(this.$advTop.size()&&this.initMimic("app-top",c.top,this.$advTop),this.$advBottom.size()&&this.initMimic("app-bottom",c.bottom,this.$advBottom),this.$advRight.size()&&this.initMimic("app-right",c.right,this.$advRight),clearTimeout(this.advRefreshTimer),delete this.advRefreshTimer)),this.advRefreshTimer=setTimeout(this.loadAdvBanners.bind(this),1e3*this.options.bannersRefreshTime)}.bind(this))},openCatalog:function(){this.catalog?(c.myrb(n.openCanvasMenu),this.hideCanvas(),this.isOpened=!0,this.$label.addClass("ico-app-arrow-prev-blue").removeClass("ico-app-arrow-next-blue"),this.$el.addClass("l-app_catalog-opened")):(this.catalog=new h({genres:this.options.genres.split(","),locales:this.options.locales,uid:this.options.vid,isMyCreated:this.options.isMyCreated}),this.catalog.init(),this.catalog.render("main",{suggestApps:this.options.suggestApps},this.onCatalogRender.bind(this))),clearTimeout(this.hideLeftTimeout)},closeCatalog:function(){this.isOpened&&(this.showCanvas(),this.isOpened=!1,this.$label.addClass("ico-app-arrow-next-blue").removeClass("ico-app-arrow-prev-blue"),this.$el.removeClass("l-app_catalog-opened"),clearTimeout(this.hideLeftTimeout))},hideCanvas:function(){this.$el.addClass("l-app_hide-canvas")},showCanvas:function(){this.$el.removeClass("l-app_hide-canvas")},slideLeftPromo:function(){this.$wrap.removeClass("m-show-left-block")},slideRightPromo:function(){this.hideLeftTimeout&&clearTimeout(this.hideLeftTimeout),this.$wrap.addClass("m-show-left-block")},onRenderCreateMyNotification:function(a){this.$container.html(a)}},protected:{initApp:function(){this.options.isNeedPreroll?this.initPreroll():this.insertAppFrame(),this.$countdown.length&&(this.eventCountdown=new i({appId:parseInt(this.options.ID,10),locales:this.options.locales}),this.eventCountdown.on("success",this.onEventSuccess.bind(this)),this.eventCountdown.init(),this.eventCountdown.$el=this.$countdown),this.options.dwhLogSession&&(a(document).on("visibilitychange.apps",this.onVisibilityChange.bind(this)),this.dwhSession=new e({autostart:!document.hidden,timeout:function(a){var b;return a=parseInt(a/1e3,10),b=a<120?5e3:a<5?1e4:3e4}}),this.dwhSession.init("app-page-session",{app_id:this.options.ID,uid:this.options.userId})),this.options.banners&&this.loadAdvBanners()},updateAdv:function(a){this.$advBottom.length&&this.$advBottom.not(":hover").length&&a.bottom&&this.$advBottom.html(a.bottom),this.$advTop.length&&this.$advTop.not(":hover").length&&a.top&&this.$advTop.html(a.top),this.$advRight.length&&this.$advRight.not(":hover").length&&"none"!==this.$rightColumn.css("display")&&a.right&&this.$advRight.html(a.right)},onLeftColumnMouseover:function(){this.slideRightPromo()},onLeftColumnMouseleave:function(){this.hideLeftTimeout=setTimeout(this.slideLeftPromo.bind(this),1e3)},onLeftColumnClick:function(){this.$wrap.addClass("m-show-left-block")},onAppClick:function(){c.myrb(n.appClick)},onAppPromoClick:function(){c.myrb(n.appPromoClick)},onAsideLabelClick:function(a,b){b.preventDefault(),b.stopPropagation(),this.isOpened?this.closeCatalog():this.openCatalog()},onGroupClick:function(){c.myrb(n.groupClick)},onInviteClick:function(){this.closeCatalog(),window.jsapiOpenDialog({template:"friends.invite"}),c.myrb(n.inviteClick)},onPaymentClick:function(){this.isPaymentOpened||(j.create({beforeOpen:this.onPaymentOpen.bind(this),beforeClose:this.onPaymentClose.bind(this)}),c.myrb(n.paymentClick))},onPaymentOpen:function(){this.isPaymentOpened=!0,this.closeCatalog(),this.hideCanvas()},onPaymentClose:function(){this.isPaymentOpened=!1,this.showCanvas()},onSettingsClick:function(){this.closeCatalog(),window.openAppSettingsWM(),c.myrb(n.settingClick)},onReviewClick:function(a){this.closeCatalog(),window.showReviewArea(a[0]),c.myrb(n.reviewClick)},onOverlayClick:function(a,b){b.stopPropagation(),this.closeCatalog()},onEventSuccess:function(){this.hideCanvas(),this.$eventPopup.addClass("app-event-popup_show")},onEventPopupCloseClick:function(){this.showCanvas(),this.$eventPopup.removeClass("app-event-popup_show")},onCatalogRender:function(a){this.$wrap.append(a),setTimeout(this.openCatalog.bind(this),50)},onVisibilityChange:function(){document.hidden?document.hasFocus()||this.dwhSession.pause():this.dwhSession.resume()},onPrerollClosed:function(){this.appsPreroll.destroy(),this.$preroll.remove(),delete this.$preroll,this.insertAppFrame()},onPrerollStart:function(){this.$preroll.addClass("m-visible")},onAdvBannersLoaded:function(a){var b={bottom:"",right:"",top:""};a.forEach(function(a){var c,d;c=String(a.slot),d='<span class="app-adv-banner banner-'+c+'">'+a.html+"</span>","66361"===c?b.top+=d:"66364"===c?b.bottom+=d:b.right+=d}),this.updateAdv(b)},onCreateMyAccClick:function(a){this.createMyAccClick||(this.createMyAccClick=!0,b.func("welcome.create_my",null,{type:"POST",success:this.onSuccessCreateMy.bind(this),error:this.onErrorCreateMy.bind(this)}))},onSuccessCreateMy:function(){c.myrb(n.clickMyNotify),this.initApp(),this.closeModal()},onErrorCreateMy:function(){this.createMyAccClick=!1}}})});