define(["jquery","counters","base/view","util/helpers","util/promise","util/css-manager","models/app","collections/apps/catalog","collections/apps/friends","collections/apps/notifies","ui/bubble2"],function(a,b,c,d,e,f,g,h,i,j,k){"use strict";var l=c.extend({props:{elements:{list:".apps-block__list",title:".apps-block__title"},events:{"click .apps-list-item__genre":"onGenreClick","click .apps-list-item__title":"onAppTitleClick",mouseleave:"onCatalogMouseLeave","mouseenter .apps-list-item__title":"onAppMouseEnter","mouseleave .apps-list-item__title":"onAppMouseLeave"},defaultOptions:{notifies:[]},model:g,templates:{"game-card":"app_catalog/tmpl/game-card","game-card-friends":"app_catalog/tmpl/game-card-friends","game-notifies":"app_catalog/tmpl/game-notifies","game-notifies-list":"app_catalog/tmpl/game-notifies-list",list:"app_catalog/tmpl/list",main:"app_catalog/tmpl/best"}},public:{init:function(){var a=this.options.preset,b=this.options.notifies;return this.collection=new h({func:this.options.func,url:this.options.url}),this.options.genre&&this.collection.setParam("genre",this.options.genre),a&&(this.collection.setResponse({data:a}),b&&b.length&&b.forEach(function(a){var b=this.collection.getById(a);b&&b.set("notify",1)}.bind(this))),this.collection.on("fetched",this.onFetched.bind(this)).on("end",this.onFetchEnd.bind(this)),this},destroy:function(){return this.collection.destroy(),delete this.collection,this.infoBubble&&(this.infoBubble.destroy(),delete this.infoBubble),l.__super__.destroy.call(this),this},fetch:function(a){var b=this.collection.getParam("genre");return this.collection.isPending()||(this.showPreloader(),a||(a=b),b!==a&&(this.$carousel?this.$carousel.empty():this.$list.empty(),this.collection.clear(),this.collection.setParam("genre",a),b=a),"all"!==b&&"other"!==b||this.collection.removeParam("genre"),this.collection.fetch()),this},renderList:function(a){return this.render("list",{items:a})},renderFriends:function(a){return this.render("game-card-friends",{friends:a})},logDWH:function(a,c){c.forEach(function(c){b.dwh({version:1,category:{"app-catalog-ctr":{uid:window.parseInt(a,10),app_id:window.parseInt(c,10),event:"show"}}})})}},protected:{onFetched:function(a,b){var c;b&&b.items&&b.items.length?(c=this.prepareRenderData(b.items),this.$el.parent().removeClass("m-hidden"),this.renderList(c).then(function(a){this.onRenderList(a),this.hidePreloader()}.bind(this))):(this.hidePreloader(),this.collection.offset||this.$el.parent().addClass("m-hidden"))},onFetchEnd:function(){this.trigger("end")},onAppTitleClick:function(a,b){var c=a.attr("data-ref");c&&(b.preventDefault(),b.stopPropagation(),window.location.href=a.get(0).href+"?ref="+c)},onGenreClick:function(a,b){b.preventDefault(),b.stopPropagation(),this.trigger("genreClick",{genre:a.attr("data-genre")}),this.infoBubble&&this.infoBubble.hide()},onRenderList:function(a){this.$list.append(a)},onRenderFriends:function(a){var b=this.infoBubble.getElement();b.find(".apps-game-card__friends-list").removeClass("m-progress").html(a.html())},onRenderGameNotifies:function(a,b){this.infoBubbleOnOpen=this.gameShowNotifies,this.showInfoBubble(a,b)},onRenderGameCard:function(a,b){this.options.uid&&(this.infoBubbleOnOpen=this.gameShowFriends),this.options.ignoreInfoBubble||this.showInfoBubble(a,b)},onAppMouseEnter:function(a,b){var c,e=a.attr("data-appid"),f=a.parent().find(".apps-list-item__pic"),g=a.find(".app-bubble-target");e||(e=a.parent().attr("data-appid")),f.length&&(a=f),g&&g.size()||(g=a),b.preventDefault(),b.stopPropagation(),this.trigger("mouseenter"),a.hasClass("ui-bubble__open")||(clearTimeout(this.infoBubbleTimer),this.infoBubble&&this.infoBubble.hide(),this.infoBubbleTimer=setTimeout(function(){var a={};this.infoBubbleAppId=e,c=this.collection.getById(e),c&&(c.get("notify")?this.render("game-notifies",c.toJSON()).then(this.onRenderGameNotifies.bind(this,g)):(c.get("screenshots").length||(a.pic=c.getPic("143x113")),a.link=c.getAppUrl("game_info"),this.render("game-card",d.extend(!0,{},c.toJSON(),a)).then(this.onRenderGameCard.bind(this,g))))}.bind(this),500))},onAppMouseLeave:function(a,b){b.preventDefault(),clearTimeout(this.infoBubbleTimer)},onCatalogMouseLeave:function(a,b){b.preventDefault(),b.stopPropagation(),clearTimeout(this.infoBubbleTimer),this.infoBubble&&this.infoBubble.hide(),this.trigger("mouseleave")},showPreloader:function(){this.$el.addClass("apps-block_loading")},hidePreloader:function(){this.$el.removeClass("apps-block_loading")},initInfoBubble:function(a){var b=this,c={target:a,corner:"horizontal top center",style:"catalog",position:{my:"center top",at:"center bottom",offset:"0 -30"},width:440,container:this.$el,beforeOpen:function(){this.element.addClass("m-hidden")},onOpen:function(){this.element.removeClass("m-hidden").addClass("app-bubble"),"function"==typeof b.infoBubbleOnOpen&&b.infoBubbleOnOpen()}};this.infoBubble=k.create(d.extend(!0,{},c,this.options.bubble))},showInfoBubble:function(a,b){var c=a.attr("data-bubble-offset");this.infoBubble||this.initInfoBubble(a),b&&(this.infoBubble.hide(),this.infoBubble.setOpener(a),this.infoBubble.setContent(b)),c||(c=this.options.bubble&&this.options.bubble.position?this.options.bubble.position.offset:"0 -30"),this.infoBubble.setPositionOffset(c),this.infoBubble.show()},prepareRenderData:function(a){return a.map(function(a){var b;return b=a.toJSON(),b.link=a.getAppUrl(),b.pic=b.pics["143x113"],b})},gameShowFriends:function(){var a=this.collection.getById(this.infoBubbleAppId);a.friendsCollection||(a.friendsCollection=new i({appId:a.get("id")})),this.options.isMyCreated?a.friendsCollection.getFriends().then(function(a){this.infoBubble.isOpen()&&(a.length?this.renderFriends(a.map(function(a){return a.toJSON()})).then(this.onRenderFriends.bind(this)):this.completeInfoBubbleProgress())}.bind(this)):this.completeInfoBubbleProgress()},completeInfoBubbleProgress:function(a){var b=a||this.infoBubble.getElement();b.find(".apps-game-card__friends-list").removeClass("m-progress"),b.find(".apps-game-card__friends-title").addClass("m-no-friends")},gameShowNotifies:function(){var a=this.collection.getById(this.infoBubbleAppId);a.notifiesCollection||(a.notifiesCollection=new j({appId:a.get("id")})),e.all([f.require("components.apps.game-notify"),a.notifiesCollection.getNotifies()]).then(function(b){var c=b[1],e=this.infoBubble.getElement().find(".apps-game-notify__content"),f=this.options.locales.inviteText;this.render("game-notifies-list",{notifies:c.map(function(b){var c={};return b.get("notifyText")||(c.notifyText=f),c.link=a.getAppUrl(b.get("ref")),d.extend(!0,{},b.toJSON(),c)})}).then(function(a){e.html(a).removeClass("m-progress")})}.bind(this))}}});return l});