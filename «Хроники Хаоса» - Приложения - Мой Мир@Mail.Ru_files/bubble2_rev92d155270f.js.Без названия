define(["jquery","factory","util/find-event-target","util/helpers"],function(a,b,c,d){var e={name:"bubble",cls:"ui-bubble",stylePrifix:"ui-bubble__style-",context:a("body")},f={bubble:e.cls,open:e.cls+"__open",content:e.cls+"__content",settings:e.cls+"__setting",corner:e.cls+"__corner"},g='<div class="js-ui-bubble '+f.bubble+'"><div class="'+f.content+'"></div><div class="'+f.settings+'"></div><div class="'+f.corner+'"></div></div>',h=[],i={target:!1,content:!1,container:!1,template:g,trigger:"none",closeButton:!1,closeOutside:!0,closeOther:!0,style:"default",corner:"horizontal top right",addClass:"",width:"auto",contentWidth:"auto",position:{my:"right top",at:"right bottom",offset:"15 10",collision:"flip"},delay:200,beforeOpen:function(){},beforeClose:function(){},onOpen:function(){},onClose:function(){}},j={open:e.name+".open",close:e.name+".close",closeAll:e.name+".cloasAll"},k=function(a){return e.stylePrifix+a},l=function(b,c){a(document).trigger(j[b],c)},m=function(a){l("closeAll",{bubble:a})},n=function(){h.forEach(function(a){a.hide()})},o=function(){a("body").on("click.dropdown",function(a){var b=c(a,"."+f.bubble);b||n()}),a(document).on(j.close,function(){e.context.off("click.dropdown")})},p=function(a){var b=a.offset();return{top:Math.round(b.top),left:Math.round(b.left)}},q=function(b){var c=this,d=a.extend(!0,{},i,b);switch(c.target=d.target,c.content=d.content,c.style=k(d.style),c.element=a(d.template).css({position:"absolute"}),c.setting=d,c.active=!1,c.element.addClass(d.corner).addClass(d.addClass),c.content&&c.setContent(c.content),c.target&&c.target.data("bubble",this),d.closeButton&&c.element.find("."+f.settings).append(a('<a class="ui-bubble__close ui-icon icon-mmico_close_gray_16" href="#"></a>').on("click",function(a){a.preventDefault(),c.hide()})),d.trigger){case"click":c.target.on("click.bubble",function(a){a.preventDefault(),c.toggle()});break;case"hover":c.target.hover(function(){c.show()},function(){c.hide()})}a(window).resize(function(a){c.hide()}),c.onPosition=c.onUpdatePosition.bind(c),a(document.body).on("head.scroll",this.onPosition).on("history-layer.scroll",this.onPosition),c.setting.closeOutside&&a(document).on(j.closeAll,function(a,b){b.bubble!==c&&c.hide()})};return q.prototype={show:function(){var a,b=this.element.find("."+f.content);return n(),this.setting.closeOutside&&o(),d.isFunction(this.setting.beforeOpen)&&this.setting.beforeOpen.call(this),d.isjQueryObject(b)&&(a=b.data("bubbleWidth")||this.setting.width,a?this.element.width(a):this.element.removeAttr("style")),this.setting.container?this.element.appendTo(this.setting.container):this.element.insertAfter(this.target),this.element.addClass(this.style).show().css({visibility:"hidden"}),this.setting.additionalClass&&this.element.addClass(this.setting.additionalClass),this.position(function(){this.element.css({visibility:"visible"}),this.isOpen(!0),this.setting.onOpen.call(this),l("open"),this.updateCornerPosition()}.bind(this)),this},hide:function(a){if(this.element){var b=this,c=b.element;return b.setting&&d.isFunction(b.setting.beforeClose)&&b.setting.beforeClose.call(b),c.hide().removeClass(b.style).removeAttr("style"),b.isOpen(!1),b.setting.onClose.call(b),l("close"),this}},onUpdatePosition:function(a){this.element&&(this.position(),this.updateCornerPosition())},position:function(a){return b("jquery-ui/position",function(){var b,c;this.element.position({of:this.target,my:this.setting.position.my,at:this.setting.position.at,collision:this.setting.position.collision}),this.setting.position.offset&&(b=this.element.position(),c=this.setting.position.offset.split(" "),this.element.css({left:Number(b.left)+Number(c[0])+"px",top:Number(b.top)+Number(c[1])+"px"})),d.isFunction(a)&&a()}.bind(this))},toggle:function(){return this.isOpen()?this.hide():this.show(),this},setWidth:function(a){this.element.find(".ui-bubble__text").width(a),this.updateCornerPosition()},getContentWidth:function(){return this.element.find(".ui-bubble__text__inner").width()},setContent:function(b){var c=this,e=d.isString(b),g=d.isNode(b),h=d.isjQueryObject(b),i=c.element.find("."+f.content);return c.content=b,e?i.html(c.content):(g||h)&&i.empty().html(a(c.content)),c},setOpener:function(b){return a(b).get(0)!==a(this.target).get(0)&&(a(this.target).removeClass(f.open),this.target=b,this.target.data("bubble",this)),this},setTarget:function(a){return this.setOpener(a),this},setPosition:function(a){return this.setting.position=a,this.position(function(){this.updateCornerPosition()}.bind(this)),this},setPositionOffset:function(a){return this.setting.position||(this.setting.position={}),this.setting.position.offset=a,this.position(),this},getContent:function(){return this.content},getElement:function(){return this.element},getContainer:function(){return this.getElement()},getOpener:function(){return this.target},getTarget:function(){return this.target},isOpen:function(b){return b===!0&&a(this.target).addClass(f.open),b===!1&&a(this.target).removeClass(f.open),a(this.target).hasClass(f.open)},updateCornerPosition:function(){if(this.element&&this.target){var b,c,d,e,g=this,h=g.element,i=g.element.find("."+f.corner),j=p(h).left,k=p(h).top,l=p(g.target).left,m=p(g.target).top;h.hasClass("vertical")&&h.hasClass("center")?j<l?(i.removeClass("left").addClass("right"),h.removeClass("left").addClass("right")):(i.removeClass("right").addClass("left"),h.removeClass("right").addClass("left")):(b=m-k,c=Math.round(h.height()-a(g.target).height()),d=k<m,e=b>=c,d&&e?(i.removeClass("top").addClass("bottom"),h.removeClass("top").addClass("bottom")):(i.removeClass("bottom").addClass("top"),h.removeClass("bottom").addClass("top")))}},confirm:function(b){var c=this,d={yes:"js-bubble__confirm-yes",no:"js-bubble__confirm-no"},e=a.extend({yes:"yes",no:"no",text:"add text?",confirm:function(){},cancel:function(){this.hide()}},b);a.extend(!0,c.setting,e);var f=a('<div><div class="ui-bubble__text"><span class="ui-bubble__text__inner">'+e.text+'</span></div><span class="ui-button-main mr10 '+d.yes+'">'+e.yes+'</span><span class="ui-button-link '+d.no+'">'+e.no+"</span></div>");return f.on("click."+b.name,"."+d.yes,function(a){return a.preventDefault(),e.confirm.call(c,a),!1}),f.on("click."+b.name,"."+d.no,function(a){return a.preventDefault(),e.cancel.call(c,a),!1}),c.setContent(f),c},destroy:function(){var b=h.indexOf(this),c=this.getElement();a(this.target).removeClass(f.open),a(document.body).off("head.scroll",this.onPosition).off("history-layer.scroll",this.onPosition),this.target=null,this.content=null,this.style=null,this.element=null,this.setting=null,this.active=null,this.onPosition=null,c&&(c.find("*").off(),c.remove()),h.splice(b,1)}},{create:function(a){var b=new q(a);return h.push(b),b},confirm:function(a,b){var c=this.create(b);return c.confirm(a),c},hide:function(){m()}}});