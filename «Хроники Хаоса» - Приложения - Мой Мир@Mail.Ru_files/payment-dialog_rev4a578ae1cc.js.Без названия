define(["jquery","client-server","base/view","util/promise","util/helpers","popup"],function(a,b,c,d,e,f){"use strict";function g(a){i?i.popup.destroyed?i.init({url:a}):i.onPayment(a):(i=new j({url:a}),i.init())}function h(a,b){var c=window.mailru,d=b.status,e="/cgi-bin/app/paymentm?";e+="success"===d?"showsuccess=1":"showfail=1",e+="&issuer_id="+b.issuer_id+"&service_name="+b.service_name+"&hide_close=1",window.winModal&&window.winModal.get("paymentDialog").down(),b.app_id&&c&&c.server?c.app_id===b.app_id&&("success"===d?((new Image).src="https://gstat.imgsmail.ru/gstat?comet.paySuccess=1&rnd="+Math.random(),c.server.events.paymentDialog.onPaymentSuccess({app_id:b.app_id,service_name:b.service_name})):c.server.events.paymentDialog.onPaymentFail(),g(e)):g(e)}var i,j,k={main:"b-payment-dialog",tabs:"b-payment-dialog__tabs",tabItem:"b-payment-dialog__tabs-item"};return j=c.extend({props:{css:["payment"],defaultOptions:{name:"payment-dialog",url:"/cgi-bin/app/paymentm?addbalance=1&mna="+b.magic().mna+"&mnb="+b.magic().mnb,width:605,height:565}},public:{init:function(){return e.isFunction(this.options.beforeOpen)&&this.options.beforeOpen(),new d(function(b,c){var d=this;this.$iframe=a("<iframe></iframe>",{height:this.options.height,src:this.options.url+"&hide_close=1",style:"visibility: hidden;",width:this.options.width,on:{load:function(){d.$iframe.css({visibility:"visible"}),d.popup.hideInsidePreloader()}}}),this.popup=f.create({rootCssClass:k.main,width:this.options.width,isAutoDestroy:!0,isShowInsidePreloader:!0,isModal:!0,hideCallback:this.onPopupHide.bind(this)}),this.popup.rendered(function(){this.popup.setContent(this.$iframe)}.bind(this)),this.popup.show(),this._bindEvents(),this.resolve=b,this.paymentResult=!1}.bind(this))},destroy:function(){e.isFunction(this.options.beforeClose)&&this.options.beforeClose(),this._unbindEvents(),this.resolve&&(this.resolve(this.paymentResult),delete this.paymentResult,delete this.resolve)},setTabs:function(b){var c=this;"string"===a.type(b)&&(b=JSON.parse(b)),this._tabsCreated||this._createTabs(),this.$tabs.empty(),b.forEach(function(b){a("<div></div>").addClass(k.tabItem).attr("data-tab-id",b.id).html(b.title).appendTo(c.$tabs).on("click",c._onTabItemClick.bind(c))})},close:function(){this.popup.destroy(),this.destroy()},resize:function(b){a.isPlainObject(b)&&(this.$iframe.css({width:b.width,height:b.height}),this.popup.setSize({height:b.height+35,width:b.width}))}},protected:{_createTabs:function(){this.$tabs=a("<div></div>").addClass(k.tabs).appendTo(this.popup.getElement()),this._tabsCreated=!0},_bindEvents:function(){this._handlers={onMessage:this._onMessage.bind(this)},window.addEventListener?addEventListener("message",this._handlers.onMessage,!1):attachEvent("onmessage",this._handlers.onMessage)},_unbindEvents:function(){window.removeEventListener?removeEventListener("message",this._handlers.onMessage):detachEvent("onmessage",this._handlers.onMessage)},onPopupHide:function(){this.destroy()},onPayment:function(b){this.$iframe.attr("src",b).load(a.proxy(function(){this.resize()},this)),this.paymentResult=!0},_onMessage:function(a){var b;try{b=JSON.parse(a.data)}catch(a){b={}}b&&b.name&&this[b.name](b.data)},_onTabItemClick:function(b){this.$iframe.get(0).contentWindow.postMessage({name:"setTab",data:{tabId:a(b.target).data("tabId")}},"*")}},static:{create:function(a){return i=new j(a),i.init()}}}),a(window).on("payment",h),window.onCometPayment=function(b,c,d,e){a(window).trigger("payment",{app_id:b,issuer_id:e,service_name:c,status:d})},j});