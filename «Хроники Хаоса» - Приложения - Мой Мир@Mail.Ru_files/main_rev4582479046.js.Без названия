define(["jquery","base/view","util/helpers","util/promise","util/css-manager","popup/fade","popup/button"],function(a,b,c,d,e,f,g){"use strict";var h=b.extend({autoInit:!0,props:{autoRemove:!0,defaultOptions:{width:400,height:"auto",marginTop:20,isAutoShow:!0,isAutoDestroy:!1,isModal:!1,isShowFooter:!0,isShowInsidePreloader:!1,rootCssClass:null,minHeight:null,closeCssClass:"icon-crumbs_delete-album"},templates:{main:"popup/tmpl/main"},css:["popup"],elements:{header:".b-popup__header",content:".b-popup__content",footer:".b-popup__footer",title:".b-popup__header__title"},events:{"click .b-popup__header__close":"onCloseClick"},vars:{isRunRender:!1},cssClasses:{showFooter:"b-popup_show-footer"}},public:{init:function(){return this.initOptions(),this.buttons=[],this.ready(this.onReady.bind(this)),this.fade=new f,this.onFadeClickHandler=this.onFadeClick.bind(this),this.fade.on("click",this.onFadeClickHandler),this.setModal(this.options.isModal),this.options.isAutoShow&&this.show(),this.onBodyKeyDownHandler=this.onBodyKeyDown.bind(this),a(document.body).on("keydown",this.onBodyKeyDownHandler),this},destroy:function(){return this.isVisible()&&this.hide(),this.fade.off("click",this.onFadeClickHandler),this.fade.isVisible()&&this.fade.hide(),a(document.body).off("keydown",this.onBodyKeyDownHandler),h.__super__.destroy.call(this),this},show:function(){return this.isRunRender||(this.render(),this.isRunRender=!0),d.all([this.rendered(),this.ready()]).then(function(){this.fade.show(),this.$el.addClass("show"),this.fade.setHeight(Number(this.$el.height())+2*Number(this.options.marginTop)),this.options.isShowInsidePreloader&&this.showInsidePreloader(),c.isFunction(this.options.showCallback)&&this.options.showCallback(this),this.trigger("show")}.bind(this)),c.display.isRetina()?e.require("sprites.all.all2x"):e.require("sprites.all.all"),this},hide:function(b){return b=b||{},this.fade.hide(),this.isDestroyed||(c.isjQueryObject(this.$el)&&this.$el.removeClass("show"),c.isFunction(this.options.hideCallback)&&this.options.hideCallback(this),this.isDestroyed||!this.options.isAutoDestroy||b.isNotAutoDestroy||this.destroy()),this.trigger("hide"),a(window.document).trigger("popup.hide"),this},hideElement:function(){c.isjQueryObject(this.$el)&&this.$el.removeClass("show")},showPreloader:function(){this.fade.showPreloader().show()},hidePreloader:function(){this.fade.hidePreloader()},showFade:function(){return this.fade.show(),this},showInsidePreloader:function(){this.$el.addClass("load")},hideInsidePreloader:function(){this.$el.removeClass("load")},setSize:function(a){return a.width&&this.$el.width(a.width),a.height&&this.$el.height(a.height),this.fade.setHeight(Number(a.height)+2*Number(this.options.marginTop)),this},getContent:function(){return this.$content},setContent:function(a){return this.renderElement(a,this.$content,!0),this.hideInsidePreloader(),this},addContent:function(a){return this.renderElement(a,this.$content),this},removeContent:function(){return c.isjQueryObject(this.$content)&&this.$content.empty(),this},getHeader:function(){return this.$header},setHeader:function(a){return this.renderElement(a,this.$title,!0),this},addButton:function(a){var b=new g(a);return b.getElement().appendTo(this.$footer),this.buttons.push(b),this.$el.addClass(this.cssClasses.showFooter),this},setButtons:function(a){return this.removeButtons(),this.addButtons(a)},addButtons:function(a){return c.isArray(a)?a.forEach(function(a){this.addButton(a)}.bind(this)):this.addButton(a),this},removeButtons:function(){return this.buttons.forEach(function(a){a.destroy()}),this.buttons=[],this.$el.removeClass(this.cssClasses.showFooter),this},getButton:function(a){var b;return this.buttons.forEach(function(c){c.getName()&&c.getName()===a&&(b=c)}),b},setModal:function(a){this.isModalMode=!!a},isModal:function(){return!!this.isModalMode},isVisible:function(){return this.$el&&this.$el.size()&&this.$el.hasClass("show")}},protected:{initOptions:function(){var b;this.constructor.options||(b=a(".b-popup-options"),b.size()&&(this.constructor.options=JSON.parse(b.html()))),this.options=a.extend(!0,{},this.constructor.options,this.options)},renderElement:function(b,d,e){e&&d.empty(),c.isjQueryObject(b)?b.appendTo(d):c.isString(b)?d.append(a("<div>"+b+"</div>")):c.isNode(b)&&a(b).appendTo(d)},onRender:function(){this.$el.appendTo(this.fade.getContainer()),this.setSize({width:this.options.width,height:this.options.height}),this.options.minHeight&&this.$el.css("minHeight",this.options.minHeight),this.setContent(this.options.content),this.setHeader(this.options.header),this.options.buttons&&this.setButtons(this.options.buttons)},onReady:function(){this.options.isAutoShow&&this.show(),c.isFunction(this.options.readyCallback)&&this.options.readyCallback(this)},onFadeClick:function(a,b){!this.isModal()&&this.isVisible()&&(!c.isjQueryObject(b.target)||0===b.target.closest(".b-popup").size()&&0!==b.target.closest(document.body).size())&&this.hide()},onCloseClick:function(){this.hide()},onBodyKeyDown:function(a){27===a.keyCode&&!this.isModal()&&this.isVisible()&&this.hide()}},static:{create:function(a){return new h(a)},getVisibleCount:function(){return a(".b-popup:visible").size()}}});return h});