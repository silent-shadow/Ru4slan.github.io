define(["jquery","client-server","base/view","app_catalog/countdown"],function(a,b,c,d){"use strict";var e;return e=c.extend({props:{defaultOptions:{maxLagTime:1e4,typeClasses:{lock:"app-event-countdown_lock",wait:"app-event-countdown_wait"}}},public:{init:function(){return this.lagTime=0,this.maxLagTime=0,this.lastVisitTime=null,this.storageKey="hilo-app-id",a(window).on("beforeunload.hilo",this.onBeforeUnload.bind(this)),a(document).on("visibilitychange.hilo",this.onVisibilityChange.bind(this)),document.hidden||this.requestAppEventStart(),this},destroy:function(){return a(window).off(".hilo"),a(document).off(".hilo"),this.countdown&&(this.countdown.destroy(),delete this.countdown),this.getStorageAppId()===this.options.appId&&localStorage.removeItem(this.storageKey),e.__super__.destroy.call(this),this},startCountdown:function(a,b){return("game"!==b||!document.hidden&&"game"===b)&&(this.countdown?this.countdown.resume(a):(this.countdown=new d({time:a}),this.countdown.on("render",this.onCountdownRender.bind(this)).on("end",this.onCountdownEnd.bind(this)).init())),b&&this.setCountdownType(b),this},resumeCountdown:function(){this.countdown&&this.countdown.start()},requestAppEventStart:function(){return this.lagTime=0,this.lastVisitTime=0,this.countdown&&this.countdown.isRun()&&this.countdown.stop(),b.func("appevent.start",{app_id:this.options.appId},{dataType:"json",success:this.onAppEventStart.bind(this)}),this},requestAppEventResolve:function(){return this.countdown&&this.countdown.isRun()&&this.countdown.stop(),b.func("appevent.resolve",{app_id:this.options.appId},{dataType:"json",success:this.onAppEventResolve.bind(this)}),this},requestAppEventSkip:function(a,c){return b.func("appevent.skip",{app_id:a},{dataType:"json",success:c}),this},setCountdownType:function(a){var b=this.options.typeClasses;this.countdownType=a,"game"===a?(this.$el.removeClass(b.wait),this.$el.removeClass(b.lock)):"wait"===a?(this.$el.removeClass(b.lock),this.$el.addClass(b.wait)):(this.$el.removeClass(b.wait),this.$el.addClass(b.lock))},getStorageAppId:function(){return parseInt(localStorage.getItem(this.storageKey),10)}},protected:{onVisibilityChange:function(a){document.hidden?(this.lastVisitTime=(new Date).getTime(),this.countdown&&"game"===this.countdownType&&this.countdown.stop()):(this.lastVisitTime&&(this.lagTime+=(new Date).getTime()-this.lastVisitTime),this.countdown?this.countdown.isRun()||(this.lagTime>this.maxLagTime?this.requestAppEventStart():this.startCountdown()):this.isDestroyed||this.requestAppEventStart())},onAppEventStart:function(a){var b,c=a[3];this.getStorageAppId()||localStorage.setItem(this.storageKey,this.options.appId),c.recheck&&(b=(new Date).getTime()+1e3*c.recheck),c.cnf&&c.cnf.time_reserv?this.maxLagTime=1e3*c.cnf.time_reserv:this.maxLagTime=this.options.maxLagTime,"success"===c.desc?this.startCountdown(b,"game"):"ratelimit"===c.desc?this.startCountdown(b,"wait"):"locked"===c.desc?this.getStorageAppId()===this.options.appId?this.requestAppEventSkip(c.additional.app_id,this.requestAppEventStart.bind(this)):this.startCountdown(b,"lock"):(this.$el.hide(),this.destroy())},onAppEventResolve:function(a){var b,c=a[3];c.recheck&&(b=(new Date).getTime()+1e3*c.recheck),"resolved"===c.desc?(this.trigger("success"),this.startCountdown(b,"wait")):"ratelimit"===c.desc?this.startCountdown(b,"wait"):"locked"===c.desc?c.additional.app_id===this.options.appId?this.startCountdown(b,"game"):this.startCountdown(b,"lock"):this.requestAppEventStart()},onCountdownRender:function(){this.$el.html(this.countdown.$el),this.$el.addClass("app-event-countdown")},onCountdownEnd:function(){"game"===this.countdownType?this.requestAppEventResolve():document.hidden||this.requestAppEventStart()},onBeforeUnload:function(){this.getStorageAppId()===this.options.appId&&localStorage.removeItem(this.storageKey)}}})});