define(["jquery","util/promise","ui/bubble2","collections/apps/catalog","app_catalog/view/catalog","jquery.jcarousel"],function(a,b,c,d,e){"use strict";var f=e.extend({props:{elements:{carousel:".apps-block__list-wrapper",controls:".apps-block__control",list:".apps-list"},events:{"click .apps-list-item__remove":"onRemoveClick"},defaultOptions:{limit:21,perPage:7,showControls:!0},templates:{main:"app_catalog/tmpl/installed"}},public:{init:function(){return this.options.total&&this.options.total<=this.options.perPage&&(this.options.showControls=!1),this.collection=new d({func:"app.installed",limit:this.options.limit}),this.collection.on("fetched",this.onFetched.bind(this)).on("end",this.onFetchEnd.bind(this)),this.removePromisesStack=[],this},destroy:function(){return this.bubble&&(this.bubble.destroy(),delete this.bubble),f.__super__.destroy.call(this),this}},protected:{onRender:function(){this.$carousel.on("jcarousel:createend",this.onCarouselCreateend.bind(this))},onRenderList:function(a){var b=this.$carousel;this.$list.append(a.children()),b.attr("data-jcarousel")?b.jcarousel("reload"):(b.on("jcarousel:scroll",this.onCarouselScroll.bind(this)),b.jcarousel(b.data()))},onCarouselCreateend:function(b,c){var d=this.$carousel;this.$controls.each(function(){var b=a(this);b.jcarouselControl({carousel:d,target:b.attr("data-target")})})},onCarouselScroll:function(){this.collection.fetch()},onFetchEnd:function(){this.$carousel.off(),this.trigger("end")},onRemoveClick:function(a,b){var d=this,e="m-active";a.hasClass(e)||(this.removeConfirmed?this.removeApp(a):(this.bubble=c.confirm({yes:this.options.locales.remove,no:this.options.locales.cancel,text:this.options.locales.removeConfirm,confirm:function(){d.removeApp(a),d.removeConfirmed=!0,this.destroy()}},{target:a,corner:"horizontal top center",style:"mini",position:{my:"center top",at:"center bottom",offset:"0 10"},width:210,container:this.$carousel,beforeOpen:function(){a.addClass(e)},onClose:function(){a.removeClass(e)}}),this.bubble.show())),b.preventDefault(),b.stopPropagation()},removeApp:function(a){var c,d=a.parents(".apps-list-item"),e=d.data("appid"),f=this.collection.getByAttr("id",e),g=this.$carousel.jcarousel("items"),h=g.index(this.$carousel.jcarousel("first"));1===g.length?this.$el.parent().slideUp():h+this.options.perPage===g.length?(c=g.slice(0,g.length-this.options.perPage),c.appendTo(this.$list),this.$carousel.jcarousel("reload").jcarousel("scroll","0",!1,function(){this.hideApp(d,200)}.bind(this))):this.hideApp(d,200),this.removePromisesStack.push(f.remove().then(function(){d.remove(),this.collection.remove(f.id),this.$carousel.jcarousel("reload")}.bind(this))),b.all(this.removePromisesStack).then(function(){this.$carousel.jcarousel("items").length<=this.options.perPage&&this.collection.fetch().then(function(){this.$carousel.jcarousel("reload")}),this.removePromisesStack=[]}.bind(this))},hideApp:function(a,b){a.animate({marginRight:0,opacity:0,width:0},b)},prepareRenderData:function(a){var b=this.options.notifies;return a.map(function(a){var c;return b.indexOf(a.get("id"))>=0&&a.set("notify",1),c=a.toJSON(),c.link=a.getAppUrl(),c.pic=c.pics["90x70"],c.removeLink=a.getRemoveUrl(),c})}}});return f});